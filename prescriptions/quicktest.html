<!DOCTYPE html>
<html><head><script src="http://maps.googleapis.com/maps/api/js"></script>
<title>Test points james-irwin@github</title>
<style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }   
      #map {
        height: 100%;
      }   
#setDrugUI, #goCenterUI, #setCenterUI {
  background-color: #fff;
  border: 2px solid #fff;
  border-radius: 3px;
  box-shadow: 0 2px 6px rgba(0,0,0,.3);
  cursor: pointer;
  float: left;
  margin-bottom: 22px;
  text-align: center;
}

#setDrugText, #goCenterText, #setCenterText {
  color: rgb(25,25,25);
  font-family: Roboto,Arial,sans-serif;
  font-size: 15px;
  line-height: 25px;
  padding-left: 5px;
  padding-right: 5px;
}

#setDrugUI, #setCenterUI {
  margin-left: 12px;
}
</style>
<script src="practices.json.full.serialised.bnf-only.js"></script>
<script src="bnf.to.name.js""></script>
<script src="drugs.full.js""></script>
<script>
var icons=['http://james-irwin.github.io/thumbs/pharmacy_plus.sm.png',
           'http://james-irwin.github.io/thumbs/pharmacy_plus.sm.pink.png',
           'http://james-irwin.github.io/thumbs/pharmacy_plus.sm.orange.png'];

/**
 * The CenterControl adds a control to the map that recenters the map on
 * Chicago.
 * @constructor
 * @param {!Element} controlDiv
 * @param {!google.maps.Map} map
 * @param {?google.maps.LatLng} center
 */
function CenterControl(controlDiv, map, center) {
  // We set up a variable for this since we're adding event listeners later.
  var control = this;

  // Set the center property upon construction
  control.center_ = center;
  controlDiv.style.clear = 'both';

  // Set CSS for the control border
  var goCenterUI = document.createElement('div');
  goCenterUI.id = 'goCenterUI';
  goCenterUI.title = 'Location';
  controlDiv.appendChild(goCenterUI);

  // Set CSS for the control interior
  var goCenterText = document.createElement('div');
  goCenterText.id = 'goCenterText';
  goCenterText.innerHTML = 'Jump to Mendip Road';
  goCenterUI.appendChild(goCenterText);

  // Set CSS for the setCenter control border
  var setCenterUI = document.createElement('div');
  setCenterUI.id = 'setCenterUI';
  setCenterUI.title = 'Click to show all prescribers';
  controlDiv.appendChild(setCenterUI);

  // Set CSS for the control interior
  var setCenterText = document.createElement('div');
  setCenterText.id = 'setCenterText';
  setCenterText.innerHTML = 'Show all';
  setCenterUI.appendChild(setCenterText);

  // Set CSS for the jump.to.drug control border
  var setDrugUI = document.createElement('div');
  setDrugUI.id = 'setDrugUI';
  setDrugUI.title = 'Drug';
  // Use 1203010Q0 as the BNF.
  controlDiv.appendChild(setDrugUI);

  // Set CSS for the control interior
  var setDrugText = document.createElement('div');
  setDrugText.id = 'setDrugText';
  setDrugText.innerHTML = 'Tamazepam';
  setDrugUI.appendChild(setDrugText);

  // Set up the click event listener for 'Center Map': Set the center of the map
  // to the current center of the control.
  goCenterUI.addEventListener('click', function() {
    //var currentCenter = control.getCenter();
    //map.setCenter(currentCenter);
    //Get the location of L81074, jump to there
    // and hide all the ther markers.
    control.centerMap('L81074', map);
  });

  // Set up the click event listener for 'Set Center': Set the center of the
  // control to the current center of the map.
  setCenterUI.addEventListener('click', function() {
    //var newCenter = map.getCenter();
    //control.setCenter(newCenter);
    control.showAll();
  });

  // Set up the click event listener for 'Show Tamazepam':
  setDrugUI.addEventListener('click', function() {
    control.showDrug('0401010T0', map);
  });

}

/**
 * Define a property to hold the center state.
 * @private
 */
CenterControl.prototype.center_ = null;

/**
 * Gets the map center.
 * @return {?google.maps.LatLng}
 */
CenterControl.prototype.getCenter = function() {
  return this.center_;
};

/**
 * Sets the map center.
 * @param {?google.maps.LatLng} center
 */
CenterControl.prototype.setCenter = function(center) {
  this.center_ = center;
};

CenterControl.prototype.centerMap = function (practicename, map) {
  var location = practices[practicename].latlng;
  map.setCenter(location);
  map.setZoom(12);
  for (practice in practices)
    practices[practice].marker.setVisible(false);
  practices[practicename].marker.setVisible(true);
  practices[practicename].marker.setIcon(icons[2]);
  practices[practicename].infoWindow.open(map);
  practices[practicename].infoWindow.setPosition(practices[practicename].latlng);
}

CenterControl.prototype.showAll = function () {
  for (practice in practices) {
    practices[practice].marker.setIcon(icons[0]);
    practices[practice].marker.setVisible(true);
  }
}

CenterControl.prototype.showDrug = function (bnf, map) {
  // First mark all practices that have this bnf in their
  // top ten one colour, then mark the total top ten
  // writers in another colour. Leave all the other markers
  // disabled.

  for (practice in practices) {
    practices[practice].marker.setIcon(icons[1]);
    practices[practice].marker.setVisible(false);
    practices[practice].infoWindow.close(map);

  for (var i=0; i<practices[practice].list.length; i++) {
      if (practices[practice].list[i] == bnf) {
          practices[practice].marker.setVisible(true);
          i=11; // All lists are top ten.
      }
    }
  }
  var topPractices=bnfwriters[bnf];
  for (i in topPractices.list) {
    if (i == 0) {
      var location = practices[topPractices.list[i]].latlng;
      map.setCenter(location);
      map.setZoom(6);
    }
    practices[topPractices.list[i]].marker.setIcon(icons[2]);
    practices[topPractices.list[i]].marker.setVisible(true);
    practices[topPractices.list[i]].marker.setZIndex(999);
  }
}
</script>

<script>
function practicename(practice, sep) {
  var str='';
  for (var i=0; i<practice.address.length-1; i++) {
    str+=practice.address[i] + sep;
  }
  str+=practice.address[i];

  return str;
}

function topscripts(practice) {
  var str='<strong>Top scripts</strong><ul>';
  for (var i=0; i<practice.list.length; i++) {
    str+='<li>' + bnfdecode[practice.list[i]];
  }
  str+='<ul>';

  return str;
}

function initialize() {
    var mapProp = { center:new google.maps.LatLng(54.975,-1.617532),
                   zoom:6, mapTypeId:google.maps.MapTypeId.ROADMAP};
    var map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
    var m=[];
    var jm=[];
    var iW=[];
    var jiW=[];
    var pcount=1;
    for (practice in practices) {
      jm[pcount]=new google.maps.Marker({
        position:new google.maps.LatLng(JSON.stringify(practices[practice].latlng.lat) , JSON.stringify(practices[practice].latlng.lng)),
        scaledSize:new google.maps.Size(2, 4),
        title:practicename(practices[practice], '\n'), icon:icons[0]});

      jm[pcount].setMap(map);
      jm[pcount].markerno=pcount;
      jiW[pcount]=new google.maps.InfoWindow({
        content:practicename(practices[practice], '<br>') + '<hr>' +
        topscripts(practices[practice])
        });

      es='google.maps.event.addListener(jm['+pcount+'], \'click\', function() { jiW['+pcount+'].open(map,jm['+pcount+']);});';
      eval(es); // Add event listener with literal indexes

      // Save the marker with the practice and now you can fiddle the icons
      // and is_visible()
      practices[practice].marker=jm[pcount];
      practices[practice].infoWindow=jiW[pcount];
      pcount++;
    }

  // Create the DIV to hold the control and call the CenterControl() constructor
  // passing in this DIV.
  var centerControlDiv = document.createElement('div');
  var centerControl = new CenterControl(centerControlDiv, map, {lat:54.975, lng:-1.617523});

  centerControlDiv.index = 1;
  centerControlDiv.style['padding-top'] = '10px';
  map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);

}
google.maps.event.addDomListener(window, 'load', initialize);
</script>
<body>
<div id="googleMap" style="position: absolute; top: 0px; bottom: 0; left: 0; right: 0;">
</div>

</body></html>
