<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>james-irwin@github</title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="dist/css/bootstrap-theme.min.css" rel="stylesheet">

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-16765789-5', 'auto');
  ga('send', 'pageview');

</script>
  </head>

  <body role="document">

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">james-irwin@github</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container theme-showcase" role="main">

      <!-- Main jumbotron for a primary marketing message or call to action -->
      <div class="jumbotron">
        <h1>Somewhere to keep ...</h1>
        <p>things that are done because I need to learn by doing.</p>
      </div>


<div id="fsaredo"> </div>
  <div class="page-header">
    <h1>Returning to the Food Standards Agency</h1>
  </div>
  <a href="https://morning-harbor-24616.herokuapp.com/"><img src="thumbs/FSADynamicVsStatic.png" class="img-thumbnail" alt="Pinning Food Standards Agency ratings again."></a>
  <div>
    <p>Map boundaries (left) rather than county boundaries (right) define what
       ratings are pinned to the map.</p>
    <p>
      <a class="btn btn-primary" href="https://morning-harbor-24616.herokuapp.com/" role="button">Site</a>
        Heroku hosted Javascript app.
    </p>
    <p><a href="http://api.ratings.food.gov.uk/help"/><button type="button" class="btn btn-info">Data</button></a>
     Food Standards Agency API
     </p>
     <p>
     <a href="http://www.github.com/james-irwin/dynamic-fsamap/"><button type="button" class="btn btn-success">Code</button></a>
    JavaScript to generate dynamic set over Google's mapping API.
    </p>
    </div>
    <div>
       <p>Dissatisfied with the static first swing at pinning the FSA rankings
          on a map, I wanted to
          dynamically pin the food outlets based on the boundaries of a
          a map.
          This switches the
          load of thousands of pins for the county to however many were
          within the selected visible area. County border problems taken care
          of at the same time.
       </p>
     </div>


      <!-- END OF FSA redo-->


<div id="anhourfromhere"> </div>
  <div class="page-header">
    <h1>Getaway driving</h1>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <p>
          <a href="anhourfromhere/AnHourHeatmap.html"><img src="thumbs/AnHourFromHereUK.png" class="img-thumbnail" alt="Google heatmap of driving distance."></a>
        </p>
        <p>
          <a class="btn btn-primary" href="anhourfromhere/AnHourHeatmap.html" role="button">Site</a> Pseudo driving distance via a heatmap in Google maps</p>
    <p><a href="anhourfromhere/fullMap.js"/><button type="button" class="btn btn-info">Data</button></a>
     Weighted heatmap points for a Google map.
     </p>
     </div>
     <div class="col-md-6">
       <p>
         <a href="anhourfromhere/AnHourContour.html"><img src="thumbs/AnHourFromHerePlotly.png" class="img-thumbnail" alt="Plotly contour map of driving distance."></a>
       </p>
       <p>
         <a class="btn btn-primary" href="anhourfromhere/AnHourContour.html" role="button">Site</a> Half hour dragnet boundaries with a contour map
       </p>
    <p><a href="anhourfromhere/ContourData.js"/><button type="button" class="btn btn-info">Data</button></a>
     Matrix input for Plot.ly
     </p>
     </div>
     <div>
       <p>
         Wondering about day trip options with a budget of only 2500 drive-time
         lookups per day with the google API. Distilled the UK into about a
         nine thousand point grid (a week of free scraping) by taking the
         <a href="https://www.ordnancesurvey.co.uk/business-and-government/products/code-point-open.html">Code-Point Open</a>
         data and finding the middle-most of each 5km box.
        </p><p>
         Four days of burning my quota to get driving distance and do a lat/long
         lookup (too lazy to calculate form the OS gridpoint):
         <img src="thumbs/AnHourFromHereAPIFull.png" class="img-thumbnail" alt="Quota fulfilled">
       </p>
       <p>
         There were a few unroutable destinations. Naturally remote places included
         a fair few in islands off the
         <a href="https://maps.google.com/maps?q=IV499BS,UK">
         coast</a>
         or in a
         <a href="https://maps.google.com/maps?q=G630JY,UK">
         loch
         </a>
         <a href="https://maps.google.com/maps?q=IV519RA,UK">
         of</a>
         <a href="https://maps.google.com/maps?q=PH414PS,UK">
         Scotland</a>,
         <a href="https://maps.google.com/maps?q=LL538DE,UK">
         off</a>
         <a href="https://maps.google.com/maps?q=SA707UH,UK">
         Wales</a>, and
         <a href="https://maps.google.com/maps?q=TR210NX,UK">
         off</a>
         <a href="https://maps.google.com/maps?q=EX392LY,UK">
         Cornwall</a>. A fair bit of the
         Shetland Islands were routable
         <a href="https://maps.google.com/maps?q=ZE29PA,UK">
         bar</a>
         <a href="https://maps.google.com/maps?q=ZE29PN,UK">
         these</a>. Novel places that wouldn't route were a
         <a href="https://maps.google.com/maps?q=PA344SX,UK">
         Parrot Sanctuary</a>
         and a
         <a href="https://maps.google.com/maps?q=SN118TJ,UK">
         cement and rubble company</a>.
       </p>
       <p>
         There's a fair bit of Scotland without enough postcodes to request a
         route. You can see the data grid by zooming in on the google heatmap.
         <div class="alert alert-success" role="alert">
           I caught myself before thinking routing was trivially linear, making
           corresponding contour (<i>dragnet</i>)  maps from any data point by
           just using deltas. Or trying to compensate and generating a data set
           form the four <i>corners</i> of the UK and interpolating when centering
           at any point. The <a href="anhourfromhere/AnHourContour.html#correlations">correlation</a>
           is, however, quite high even from the
           awkward corner of the UK I chose as the origin/home. Another 
           <a href="anhourfromhere/AnHourContour.html">plot</a>
           from a central postcode (DE126DW near Ashyby-de-la-Zouch) shows
           a reasonably unhindered escape in all directions.
         </div>
         On my way to the Plot.ly and Google heat map, I pushed very similar
         data into Octave and Kibana respectively. The Kibana small multiple
         of one two and three hours out from the origin with a scripted field
         is below:
       </p>

  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <p>
          <img src="thumbs/AnHourKibana.png" class="img-thumbnail" alt="Google heatmap of driving distance.">
        </p>
      </div>
      <div class="col-md-4">
        <p>
          <img src="thumbs/ASecondHourKibana.png" class="img-thumbnail" alt="Google heatmap of driving distance.">
        </p>
      </div>
      <div class="col-md-4">
        <p>
          <img src="thumbs/AThirdHourKibana.png" class="img-thumbnail" alt="Google heatmap of driving distance.">
        </p>
      </div>

    </div>
  </div>

     </div>
   </div>
</div>


      <!-- END OF an hour from here-->



<div id="fitness"> </div>
      <div class="page-header">
          <h1>Fitness data</h1>
      </div>
        <a href="#contact"><img src="thumbs/HeartRateHeatMap.png" class="img-thumbnail" alt="Kibana geo-heatmap of my heartrate around Bristol."></a>
<div>
    <p>Heart rate nice and low on the train but walking to the park and ride,
       while faster than the bus that day, was a fair trek. My heart rate
       looks like a terrain proxy.
    </p>
    <p>
        <a href="http://www.github.com/james-irwin/fitness/"><button type="button" class="btn btn-success">Code</button></a> Python &amp; Javascript to ETL Garmin or Strava files into Elasticsearch.
    </p>
</div>

<div>
    <p>My goal is to swim 100m in one minute. Practice is what will count, but
       tracking how well I'm doing is interesting. There's the corporate
       <a href="https://connect.garmin.com/">Garmin connect</a> and Stephane's
       <a href="http://www.swimmingwatchtools.com">Swimming Watch tools</a>
       to look at your stats. However, there's a tonne more data coming out of a
       fitness watch. And I need to practice a little more ETL.
    </p>
    <p>
       The Garmin watches turn out a FIT format file that is licenced but
       available to developers through an
       <a href="https://www.thisisant.com/resources/fit">SDK</a>.
       The code includes a <a href="http://www.github.com/james-irwin/fitness/blob/master/garmin_fit/decode.cpp.patch">patch</a>
       to the SDK example (<tt>cpp/examples/decodeMac</tt>) to emit something more
       JSON-like to feed into a
       <a href="https://github.com/james-irwin/fitness/blob/master/garmin_fit/push.fit.docs.to.es.py">python loader</a>
       for elastic search.
    </p>
    <p>
       The Strava downloads are GPX format XML files. These are converted with
       a little <a href="https://github.com/james-irwin/fitness/blob/master/strava_gpx/src/gpx.to.json.js">Node/Javascript</a>
       before another
       <a href="https://github.com/james-irwin/fitness/blob/master/strava_gpx/src/push.gpx.docs.to.es.py">python loader</a>
       for elastic search.
    </p>
    <a href="#contact"><img src="thumbs/ParkStreetHeartRate.png" class="img-thumbnail"     alt="Walking up the hill to the pool"></a>
    <p>
       Just to make sure the data is loaded, a quick check with proper science
       says the first five minutes of walking to the pool shows
       altitude <i>causing</i> my heart rate ;)
    </p>
    <p>
       The goal measurement is done in Kibana as a scripted field from the
       Garmin <tt>avg_speed</tt> field (milimeters per second).
<pre>(doc['avg_speed'].value==0.0)?0.0:((100.0/(doc['avg_speed'].value/1000.0))-60.0)</pre>
       gives the number of seconds I'm over the pace of one minute for 100m.
       First swim with a cold and watch that broke on its first outing in an
       odd-length pool but I have numbers!
    </p>
    <a href="#contact"><img src="thumbs/SecsOver1mFor100m.png" class="img-thumbnail"     alt="Baseline swim speed"></a>

      <!-- END OF fitness dash -->
<div id="mot-dash"> </div>
      <div class="page-header">
          <h1>Vehicle test result dashboard</h1>
      </div>
        <a href="#contact"><img src="thumbs/NewDash.Final.png" class="img-thumbnail" alt="Kibana dashboard of 36m MOT tests."></a>
<div>
    <p>I didn't know the average vehicle was over nine-years old on the day it
       was put in for its MOT.
    </p>
    <p>
        <a href="http://www.github.com/james-irwin/mot-dash/"><button type="button" class="btn btn-success">Code</button></a> Python to ETL the CSV files into Elasticsearch.
    </p>
    <p>
    <a href="https://data.gov.uk/dataset/anonymised_mot_test"><button type="button" class="btn btn-info">Data</button></a> Anonymised MOT test data.
    </p>
</div>

<div>
    <p>
I needed to write an ETL in Python, and I wanted to start to use Kibana in anger.
Python seems inescapable and I spent a few days trying to get to grip with the
<a href="http://stackoverflow.com/questions/2573135/python-progression-path-from-apprentice-to-guru">basics</a>.
 Unlike the other visualisations, Kibana runs as a live
service, atop an equally live Elasticsearch instance. After running on my laptop,
I could then re-benchmark and host this on a cloud service for demonstrations.
    </p>
    <p>
I took the <a href="http://data.dft.gov.uk/anonymised-mot-test/12-03/test_result_2013.txt.gz">2013 results data</a>
as this was the most recent data set and at 36m rows was a reasonable sized sample.
The <a href="http://www.github.com/james-irwin/mot-dash/">ETL</a> code, like
all the others, basically takes one line at a time from the CSV file and turns it
into a Python dict. These are aggregated and pushed into Elastic search through
the bulk interface. The (single threaded, single buffered) job takes an hour
on my macbook and two hours on a two-core AWS instance. It took an hour longer on 
a Google Compute instance but I wasn't really sure I was doing it right
    </p>
<a href="#contact"><img src="thumbs/AWS.ETL.png" class="img-thumbnail"     alt="AWS 2-core VM usage profile at about 10p per hour."></a>
<p>
I loaded the data from the compressed file (and stripped the UNCLASSIFIED vehicles)
to minimise read-bandwidth and disk space
<pre>$> mkfifo data.pipe
$> gunzip -c data/test_results.gz | sed -e "/UNCLASSIFIED/d" > data.pipe &
$> etl/MOT.csv.to.es.py data.pipe
</pre>

<p>
To get satisfactory dashboard performance, I ended up choosing a four
core instance (n1-highcpu-4) with 3.6 GB memory for the Elastic server and a
simple one-core (n1-standard-1) for the Kibana server. The loaded Elastic index
was about 4Gb and the Java runtime never used all the RAM. This costs
about 20p per hour to run.
</p>

<a href="#contact"><img src="thumbs/NewDash.Final.Ford.Focus.png" class="img-thumbnail"     alt="Filtered dashboard to profile the Ford Focus Zetec"></a>
<p>
The most popular vehicle tested was the Ford Focus Zetec, filtered with two clicks
on the pie charts and a wait of a couple of seconds as the 36m rows are processed.
They're generally two years older, and fail more often than the average vehicle
tested.
</p>

<a href="#contact"><img src="thumbs/NewDash.Final.Ferrari.tall.png" class="img-thumbnail"     alt="Filtered dashboard to profile the Ferraris"></a>

<p>
Ferraris, on the other hand, are rarer, younger and fail their MOTs less. The
time that Ferraris are tested, biased towards the end of winter and spring suggests,
perhaps, these are summer cars. Clearly red, is the colour for your Ferrari.
Somehow, there are a couple of MOT records for diesel Ferraris?
</p>

<a href="#contact"><img src="thumbs/iOS.simple.dash.png" class="img-thumbnail"     alt="Simple key-metric dashboard on a phone"></a>
<p>
A summary metrics dashboard showing the data for two days fits nicely on a phone.
The beauty of Kibana and Elasticsearch setup like this means a live feed into
into Elastic permits auto-refresh (5 second) updates to trends of metrics that are
operationally critical as I was able to see when developing the dashboard and
loading the 36m rows simultaneously.
</p>

      <!-- END OF MOT dash -->

<div id="prescriptiontrends"> </div>
      <div class="page-header">
          <h1>Prescription trends</h1>
      </div>
        <a href="http://james-irwin.github.io/prescriptions/practicehabits.html"><img src="thumbs/prescriptionslope.png" class="img-thumbnail" alt="League table for prescribed drugs"></a>
<div>
<p>
I wanted to know what we were medicating our prisoners with. Then I wanted to
see the historical trending top ten things written there. <a
href="http://james-irwin.github.io/prescriptions/practicehabits.html">Type
'HMP' in the search box to see</a>.
</p>
<p>
Analysing three times as much data as the prescription drug map below
(over thirty million rows) and trending the top ten with a trivial search
by practice address. Slopegraphs in the league position style rather than the
prescribed quantity show relative positions rather than relative volume.
</p>
</div>
<div id="prescription"> </div>
      <div class="page-header">
          <h1>Top drug writers</h1>
      </div>
        <a href="http://james-irwin.github.io/prescriptions/medicinehub.html"><img src="thumbs/prescriptions.png" class="img-thumbnail" alt="Where are the popular spots for writing diazepam?"></a>
<div>
<p>
Is the surgery opposite the watersports park still the top place for dispensing
entonox? What are we mostly medicating prisoners with?
</p>
<p>
        <a href="http://james-irwin.github.io/prescriptions/medicinehub.html"><button type="button" class="btn btn-primary">Site</button></a> Look at which practice/pharmacy writes the most of a given drug.
    </p>
    <p>
        <a href="http://www.github.com/james-irwin/prescriptions/"><button type="button" class="btn btn-success">Code</button></a> JavaScript to aggregate records loaded into Elastic Search.
    </p>
    <p>
    <a href="http://www.hscic.gov.uk/searchcatalogue?q=title:%22presentation+level+data%22&area=&size=10&sort=Relevance"><button type="button" class="btn btn-info">Data</button></a> Monthly prescription data.
    </p>
</div>

<div>
<p>
More JavaScript in the client, with the google maps API, and a proper
aggregation in elastic search. The key structure is the practice record:
</p>
<pre>
var practices = { ...
"Y02307": {
           "latlng":{"lat":51.4806202,"lng":-2.590658},
           "list":["0410030C0","0407010P0","0408010AE","0401020K0",
                   "0403010B0","0410030A0","0109040N0","0403030Q0",
                   "0402010AB","0403010V0"],
           "address":["HMP BRISTOL","19 CAMBRIDGE ROAD","BRISTOL","","BS78PS"]
          },
...
};
</pre>
<p>
The practice ID is a foreign key in the source data set joining the
<a href="http://datagov.ic.nhs.uk/presentation/2015_07_July/T201507PDPI+BNFT.CSV">prescription records</a>
to the
<a href="http://datagov.ic.nhs.uk/presentation/2015_07_July/T201507ADDR+BNFT.CSV">address</a>.
I can use this when keying from the drug record below. Y02307
is the prison in Bristol. I used
<a href="http://maps.googleapis.com/maps/api/geocode/json?address=HMP%20BRISTOL%2019%20CAMBRIDGE%20ROAD%20BS78PS">google's geocoder</a>
to generate and cache the
latitude &amp; longitude -- in batches because of the 2,500 per day limit.
The <i>list</i> is the top ten, in decreasing order, BNF codes for the
drugs prescribed by this practice. For comparison, the aggregation in SQL
</p>
<pre>
sql> select bnf, sum(quantity) q from prescriptions where practice='Y02307'
     group by bnf order by q desc limit 10;
</pre>
<p>
Is about what I get from the elastic aggregation
</p>
<pre>
$> curl 'localhost:9200/_search?q=practice:Y02307&amp;size=0'
     -d '{
          "aggs": {
                   "by_drug": {
                               "terms": {
                                         "field": "bnf",
                                         "order" : {"total_quantity":"desc"}
                                        },
                               "aggs": {
                                        "total_quantity": {"sum": {"field": "quantity"}}
                                       }
                              }
                  }
         }'
</pre>
<p>
The source data provides
<a href="http://datagov.ic.nhs.uk/presentation/2015_07_July/T201507CHEM+SUBS.CSV">readable
BNF translations</a> for non-medics.
For the drug-to-map client, I have a similar but inverted
<a href="https://github.com/james-irwin/prescriptions/blob/master/rank.each.drug.js">elastic aggregation</a>.
This
is the top ten locations prescribing a given BNF.
<a href="http://james-irwin.github.io/prescriptions/medicinehub.html"><img src="thumbs/prescriptions-key.png" class="img-thumbnail" alt="Amoxycillin top ten writer vs practice with Amoxycillin in its top ten popular prescriptions."></a>
The Ridge Medical Centre writes more Amoxycillin than Burmantofts Health Centre
even though Amoxycillin is in the top ten things written at Burmantofts and not
in the top ten at Ridge. What's not shown is how many patients each practice is
serving.
</p>



</div>

<div id="word-pairs"> </div>
      <div class="page-header">
          <h1>Stylometry &amp; stylo-sympathy</h1>
      </div>
        <a href="http://james-irwin.github.io/word-pairs/"><img src="thumbs/word-pairs.png" class="img-thumbnail" alt="Write-like and style-comparison of texts."></a>
<div>
    <p>
        I wondered how real stylometry might be and, better than that, could a machine help me write sympathetically in a given style? It arose from wondering about simultaneous multiple auto-suggest feeds and <a href="https://www.washingtonpost.com/world/national-security/code-name-verax-snowden-in-exchanges-with-post-reporter-made-clear-he-knew-risks/2013/06/09/c9a25b54-d14c-11e2-9f1a-1a7cdee20287_story.html">the request to not be quoted at length</a>.
    </p>
<p>
        <a href="http://james-irwin.github.io/word-pairs/"><button type="button" class="btn btn-primary">Site</button></a> Write-like a few classics and compare them too.
    </p>
    <p>
        <a href="http://www.github.com/james-irwin/word-pairs/"><button type="button" class="btn btn-success">Code</button></a> JavaScript to generate word-distribution distillates; compare them and consume them.
    </p>
    <p>
    <a href="http://www.gutenberg.org"><button type="button" class="btn btn-info">Data</button></a> Project Gutenburg.
    </p>
</div>

<div>
    <p>
        I started with a body of standard texts:
        <a href="http://www.gutenberg.org/ebooks/10.txt.utf-8">The King James Bible</a>
        and <a href="http://www.gutenberg.org/ebooks/100.txt.utf-8">the complete works of
        Shakespeare</a>. I'd used both before as sources of word streams for benchmarking.
        Before analysing, I picked up a couple more samples that I might want to compare
        which meant <a href="http://www.gutenberg.org/ebooks/31100.txt.utf-8">all of Jane
        Austen</a> and <a href="http://www.gutenberg.org/files/30486/30486-0.txt">Bronte's
        Shirley</a> to go with Shakespeare; an
        <a href="http://www.gutenberg.org/ebooks/3434.txt.utf-8">English translation
            of the Koran</a> and an
        <a href="http://www.gutenberg.org/ebooks/7864.txt.utf-8">English translation of the Mahabharata of Krishna</a> to weigh against a partitioned Bible (old and new testaments).
        The first step was to distill the text into something to use for both
        auto-suggesting and a basis for the comparison operation. The end resut was a Markov-
        chain like structure:
    </p>
<p>
    <pre>
residue = ["word_1": ["following_word_1.1", "following_word_1.2", ... ],
           "word_2": ["following_word_2.1", "following_word_2.2", ... ], ...
          ]</pre>
</p>
    <p>
        Where the words in the structure above are frequency sorted. I dropped the occurence
        counts for precise distributions and assumed a common (power-) curve for simplicity.
    </p>
    <div class="alert alert-warning" role="alert">
    I was, as with the previous experiments, trying to keep learning JavaScript but it made no
    sense if I could do the grunt work by piping together a few binutils classics. The
    JavaScript step in this turns the text into word-pairs (or word --&gt;
    following word-pair) and thresholds the result (truncating the very long tails).
    Otherwise the punctuation was removed with <i>tr</i>; ordering and counting with
    <i>sort</i> and <i>uniq</i>; and JSON-ification with trivial <i>AWK</i>. Premature
    implementation of all the steps in JavaScript would have missed the point: To see if
    stylometry from this residue might be convincing and if I could make a sumultaneous
    multi-auto-suggest from it. The <a href="https://github.com/james-irwin/word-pairs/blob/master/tools/wpdist.sh">distillation</a>
    of the 880k words of Shakespeare takes thirty seconds. The rest were completed in a couple
    of minutes. The slowest part was manually trimming the texts of their introductory and
    explanatory envelopes.
    </div>

<p>
    First to use the output were the auto-suggesters based on Nicholas Zakas'
    <a href="http://oak.cs.ucla.edu/cs144/projects/javascript/suggest1.html">tutorial</a>.
    Using a simple probability distributon function to pick the <i>next word</i>, iterated a
    few times and while I typed, a satisfactory prompt came from the suggester.
</p>
    <div class="alert alert-danger" role="alert">
    Single-word based Markov chains read badly so I switched the distiller to produce
    following word pairs. Iterating <i>"word": ["word-pair_1", "word-pair_2", ...]</i>
    read much easier and is used on the <a href="http://james-irwin.github.io/word-pairs/">page</a>
    for the <i>classics</i> and <i>scripture</i> suggesters.
    </div>
<p>
To compare two Markov-chains -- I haven't read anything about how stylometry is done
properly -- I used a three dimensional metric that I could bubble-chart using
    <a href="http://canvasjs.com/">CanvasJS</a> charts for a change.
    The size of the intersection of two word lists as a percentage of the union is the y-axis
    (<i>inness</i>) and the absolute size of the intersection is the bubble size.
    This is to give an
    idea of the commonality between two texts. This doesn't eliminate inescapable common word-
    pairs of a written language but might give a sense of overlap. The third dimension (x-axis
    in the <a href="http://james-irwin.github.io/word-pairs/">example</a>) is the
    frequency order comparison (<i>likeness</i>) computed as a rank correlation using the
    <a href="http://simplestatistics.org/">simple statistics</a> library. Both the parallel
    suggesters and the bubble-chart with annotations are intersting to play with as a result.
</p>
</div>

<div id="enronmail"> </div>
      <div class="page-header">
          <h1>Sankey diagrams of Enron email via Elasticsearch</h1>
      </div>
        <a href="http://james-irwin.github.io/enron/"><img src="thumbs/enron.even.png" class="img-thumbnail" alt="Enron mail analytics."></a>
<div>
    <p>
        An excuse to draw Sankey diagrams and learn to do aggregations in Elasticsearch. The Enron mail corpus fit and was plenty less trendy than twitter/facebook feeds. Check out <a href="http://james-irwin.github.io/enron/vince.kaminski.batwings.html">Vince Kaminski</a> (an objector to the practices with a fat cc: pipe to himself outside of Enron) or <a href="http://james-irwin.github.io/enron/rosalee.fleming.batwings.html">Rosalee Flemming</a> (Ken Lay's assistant, a broadcast beacon to the top brass).
    </p>
<p>
        <a href="http://james-irwin.github.io/enron/"><button type="button" class="btn btn-primary">Site</button></a> Sankey diagrams (with clickable fudge).
    </p>
    <p>
        <a href="http://www.github.com/james-irwin/enronsankey/"><button type="button" class="btn btn-success">Code</button></a> JavaScript to generate Sankey diagrams from aggregates collected from Elasticsearch.
    </p>
    <p>
    <a href="https://www.cs.cmu.edu/~./enron/"><button type="button" class="btn btn-info">Data</button></a> Enron email corpus.
    </p>
</div>

<div>
    <p>
            The tarball of data needed loading into <a href="https://www.elastic.co/">Elasticsearch</a>. I used <a href="https://github.com/andris9/mailparser">mailparser</a> in processing each file to generate an Elasticsearch entry demultiplexing multiple names on the <i>To:</i> line.
    </p>
    <p>
    <pre>node mail.to.es.js .../enron/enron_mail_20110402/maildir/crandell-s/inbox/2. </pre>
    </p>
    <div class="alert alert-danger" role="alert">
    That took half a second to load the single mbox-format mail and generate forty-one documents in Elasticsearch (a sample with a long <i>To:</i> list). With half a million files the machine was left running while I floored the loft over a weekend. There's a lot of fat left on that pork chop to speed it up. In the end there are 3.1m documents in the Elasticsearch index.
    </div>
    <p>
    The simple, first Sankey aggregations I wanted was the bowtie as in the image above. This would effectively be the pair:
    </p>
<pre>SELECT 'FROM', COUNT(*) AS C WHERE 'TO'='mike.mcconnell' FROM ENRONMAIL GROUP BY 'FROM' ORDER BY C DESC;
SELECT 'TO', COUNT(*) AS C WHERE 'FROM'='mike.mcconnell' FROM ENRONMAIL GROUP BY 'TO' ORDER BY C DESC;
</pre>
<p>
    Shove that into a basic <a href="https://developers.google.com/chart/interactive/docs/gallery/sankey">Sankey</a>
    and you're away. I wanted to make the full set and have them navigable by clicking
    on the names of the branches to recentre the bowtie. Initially, that
    <a href="https://stackoverflow.com/questions/30337430/select-event-not-fired-on-google-chart-api-for-sankey">wasn't possible</a>
    but the StackOverflow community got me to the right remedy.
</p>
    <p>
    I used a modified version of the Sankey generator and iterated it a few times
    on the list of names it found to build a three-degrees from Rick Buy (or whoever)
    totaling 1826 names to then batch run the lot. Sankeyfying for those names took
    2mins 12secs. That's fast enough to do on demand.
    </p>
    <div class="alert alert-success" role="alert">
    Since these little bowtie Sankey diagrams take less than a tenth of a second each,
    I want to dial it up a step and go out one branch farther. To have a
    <i>from:from</i> feed into the <i>from</i> left hand side and the mirror
    on the right. That turns the number of aggregations up from two about the
    centre name to twenty-two.
    </div>
    <p>
    First pass at a batwing to just extend the left (from/from) helped with error
    discovery. Added lots of <tt>&lt;namestring&gt;.replace(/\'/g,"");</tt>
    for the O'Days, O'Haras, O'Keeffes and so on. I could've escaped them or
    like I have here, just dropped them.
    </p>
    <a href="http://james-irwin.github.io/enron/mike.mcconnell.batwings.html"><img src="thumbs/half.batwing.png" class="img-thumbnail" alt="Enron mail analytics."></a>
</div>
    <p>
    A matching set of batwings linked to bowtie Sankey views (click the centre namebar)
    generated in 2mins 59secs for twenty times as much work done in
    Elasticsearch. Still sub a tenth of a second each. Possible on demand then,
    probably while continually indexing new documents as they pass through the mail
    system.
    </p>

      <!-- END OF ELSATIC/ENRON -->

<div id="fsamap"> </div>
      <div class="page-header">
          <h1>JavaScript via the Food Standards Agency</h1>
      </div>
        <a href="http://james-irwin.github.io/fsa/"><img src="thumbs/fsa.png" class="img-thumbnail" alt="Food Standards Agency inspection ratings pinned over a Google map."></a>
<div>
    <p>
    I wanted to learn a little JavaScript and being a non-UI person
    I did <a href="http://nodeschool.io/#workshoppers"><em>learnyounode</em></a>
    until I thought I had enough to start something in anger.
    </p>
    <p>
    <a href="http://james-irwin.github.io/fsa/"><button type="button" class="btn btn-primary">Site</button></a>
    FSA inspection ratings gathered by county pinned over Google's map.
    </p>
    <p>
    <a href="http://www.github.com/james-irwin/fsamap/"><button type="button" class="btn btn-success">Code</button></a>
    JavaScript to generate static HTML set over Google's mapping API.
    </p>
    <p>
    <a href="http://ratings.food.gov.uk/open-data/en-GB"><button type="button" class="btn btn-info">Data</button></a> Food Standards Agency inspection ratings data.
    </p>
</div>
<div>
<p>
I wanted all the data, and it comes in XML and JSON options. Curl it in batches via
</p>
<p>
    <pre>curl http://ratings.food.gov.uk/search/%5E/%5E/1/5000/xml</pre>
</p>
<p>
    Where <tt>%5E</tt> (^) effectively means a wildcard for both the name of the
    county and the establishment that was inspected. Replace <tt>xml</tt> with
    <tt>json</tt> for JSON formatted equivalent. <tt>1</tt> is the page number and
    <tt>5000</tt> the page size. That's the largest page size I managed to collect
    -- for a total of about a hundred pages, the result includes metadata with the
    number of pages at your selected page size. The GitHub repo has an example
    <a href="https://github.com/james-irwin/fsamap/tree/master/examples">HTML output</a>
    for just the first 5000 elements.

<div class="alert alert-danger" role="alert">
    Mushing all the FSA inspection data into one large JSON file totals
    <strong>346Mb</strong>! Throwing away most of that to just pin the location,
    the rating and the name will make a single file in the tens of megabytes range.
    Plus node didn't like <tt>fs.readfile()</tt> on a 346Mb file and I didn't have
    need/care to switch to a streamed implementation. I'm writing my first JavaScript
    program and didn't want any back-end otherwise I would use elasticsearch and mark
    the dynamically pulled inspections within the bounds of the Google map.
</div>
</p>
<p>
    As published, the data is partitioned into counties so I scraped the 406 files by
    curling the <a href = "http://ratings.food.gov.uk/open-data/en-GB" >data page</a>
    and piping it through <tt>grep http://ratings.food.gov.uk/OpenDataFiles/ | grep English</tt>
    to see something I could use <tt>cut</tt> to strip out the county names and the
    file names to re-<tt>curl</tt>. The GitHub repo has the
    <a href="https://github.com/james-irwin/fsamap/tree/master/xmldata">xml data for North Somerset</a>
    as a snapshot.
</p>
<p>
    <a href="https://developers.google.com/maps/documentation/javascript/markers">Google maps with pins are surprisingly simple</a>.
    After installing <tt>xml2js</tt> to parse the xml with:
<pre>
var xml2js = require('xml2js');
var parser = xml2js.Parser();
parser.parseString(data, function (err, result) {...
</pre>
The inspection set for this county (loaded into <tt>data</tt> via <tt>fs.readFile()</tt>) is now navigable as a JavaScript object.
<div class="alert alert-danger" role="alert">
    Parsing 406 xml files to put a few thousand pins for the county you're interested in
    plus 405 <em>jump</em>-pins at appropriate places on the map takes over
    <strong>three minutes!</strong> on my 2014 MacBook Pro. Scaling that even with the
    two cores takes about <strong>eight hours</strong> for the set.</div>

    I had overnight to let it run rather than do a smarter thing and cache the 406
    <em>jump</em>-pins. Then I realised I needed something better anyway...</div>

<div class="alert alert-danger" role="alert">
    A dozen or so maps wouldn't load, the error console bemoaning
    <strong>RangeError: Maximum call stack size exceeded</strong>. Thinking about it,
    turned out it was because I was simply emitting all the inspections and using
    <tt>map.panTo(m[0].position)</tt> -- the first marker so that the map was centred
    over a pin in the county rather than calculate the proper centre of the map first
    and then emit the cloud of markers. Heed the quality of the data!
</div>
<p>
    Wanting to avoid re-writing it with a cached set of <em>jump</em>-pins I bulk
    converted all the <tt>xml</tt> files to <tt>JSON</tt> with
    <tt>JSON.stringify()</tt> as the body to the callback of the
    <tt>xml2js::parser.parseString()</tt> function and exchanged the <tt>xml</tt>
    parser call to a <tt>JSON</tt> parser call (<tt>JSON.parse(data)</tt>). Took
    only a couple of minutes.
<div class="alert alert-success" role="alert">
    Two wins: Firstly, three minutes per county <tt>xml</tt> turned into
    <strong>seven seconds</strong> per county <tt>JSON</tt> (less than half
    an hour to do the lot now) and secondly, skipping inspections that have otherwise
    <tt>undefined</tt> lat/long data made the browser come alive and all the counties
    I tried worked.</div>
    </p>
<div class="page-header" id="contact">
    <h1>Contact</h1>
</div>
<div class="row">
    <div class="col-sm-4">
        <a href="http://uk.linkedin.com/pub/james-irwin/5/313/a03"><img src="thumbs/Logo-2C-34px-R.png" class="img-thumbnail" alt="LinkedIn profile for James Irwin."></a>
        <a href="http://www.github.com/james-irwin/"><img src="thumbs/GitHub_Logo.png" class="img-thumbnail" alt="GitHub for James Irwin."></a>

    </div><!-- /.col-sm-4 -->
</div>
      </div>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="dist/js/bootstrap.min.js"></script>
</script>
  </body>
</html>
